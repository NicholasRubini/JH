<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="H«™PP">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#D4AF37">
    <meta name="format-detection" content="telephone=no">
    
    <title>H«™PP - Jump Height Estimator</title>
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkhPUFAgLSBKdW1wIEhlaWdodCBFc3RpbWF0b3IiLAogICJzaG9ydF9uYW1lIjogIkhPUFAiLAogICJkZXNjcmlwdGlvbiI6ICJTdGltYSBsJ2FsdGV6emEgZGVsIHNhbHRvIGNvbiBhbmFsaXNpIHZpZGVvIGZsaWdodCB0aW1lIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwRDBEMEQiLAogICJ0aGVtZV9jb2xvciI6ICIjRDRBRjM3IiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA1MTIgNTEyJz48cmVjdCBmaWxsPSclMjMwRDBEMEQnIHdpZHRoPSc1MTInIGhlaWdodD0nNTEyJyByeD0nNjQnLz48dGV4dCB4PScyNTYnIHk9JzMyMCcgZm9udC1zaXplPScyMjAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9JyUyM0Q0QUYzNyc+4ZqoPC90ZXh0Pjwvc3ZnPiIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%230D0D0D' width='512' height='512' rx='64'/><text x='256' y='320' font-size='220' text-anchor='middle' fill='%23D4AF37'>·ö∫</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --nero-carbone: #0D0D0D;
            --oro-runico: #D4AF37;
            --grigio-profondo: #1A1A1A;
            --bianco-ghiaccio: #F5F5F5;
            --oro-dim: rgba(212, 175, 55, 0.15);
            --oro-glow: rgba(212, 175, 55, 0.4);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Source Sans Pro', -apple-system, sans-serif;
            background: var(--nero-carbone);
            color: var(--bianco-ghiaccio);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: var(--safe-top) 0 var(--safe-bottom);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at 30% 10%, var(--oro-dim) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 90%, var(--oro-dim) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .app {
            min-height: 100%;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            max-width: 500px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 1.5rem 0 1rem;
        }

        .logo-rune {
            font-size: 2rem;
            color: var(--oro-runico);
            letter-spacing: 0.4rem;
            text-shadow: 0 0 20px var(--oro-glow);
        }

        h1 {
            font-family: 'Cinzel', Georgia, serif;
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: 0.2rem;
            margin: 0.3rem 0;
        }

        .subtitle {
            color: rgba(245,245,245,0.5);
            font-size: 0.75rem;
            letter-spacing: 0.15rem;
            text-transform: uppercase;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, rgba(212,175,55,0.08), rgba(212,175,55,0.03));
            border: 1px solid rgba(212,175,55,0.25);
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.9rem 1rem;
            cursor: pointer;
            background: rgba(212,175,55,0.05);
        }

        .info-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--oro-runico);
        }

        .info-toggle {
            color: var(--oro-runico);
            transition: transform 0.3s;
        }

        .info-box.open .info-toggle { transform: rotate(180deg); }

        .info-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .info-box.open .info-content { max-height: 2000px; }

        .info-inner { padding: 1rem; padding-top: 0; }

        .info-section { margin-bottom: 1rem; }
        .info-section h4 {
            font-size: 0.8rem;
            color: var(--bianco-ghiaccio);
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            margin-bottom: 0.5rem;
        }

        .info-section ul { list-style: none; }
        .info-section li {
            padding: 0.3rem 0 0.3rem 1.2rem;
            position: relative;
            font-size: 0.85rem;
            color: rgba(245,245,245,0.7);
        }
        .info-section li::before {
            content: '‚Ä∫';
            position: absolute;
            left: 0;
            color: var(--oro-runico);
        }

        .fps-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .fps-table th, .fps-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid rgba(212,175,55,0.15);
        }
        .fps-table th { color: var(--oro-runico); font-size: 0.7rem; text-transform: uppercase; }

        .accuracy-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .accuracy-low { background: rgba(255,107,107,0.2); color: #FF6B6B; }
        .accuracy-med { background: rgba(255,193,7,0.2); color: #FFC107; }
        .accuracy-high { background: rgba(78,205,196,0.2); color: #4ECDC4; }
        .accuracy-max { background: rgba(212,175,55,0.2); color: var(--oro-runico); }

        .tip-highlight {
            background: rgba(212,175,55,0.1);
            border-left: 3px solid var(--oro-runico);
            padding: 0.6rem 0.8rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: rgba(245,245,245,0.8);
        }

        /* Sport Benchmarks */
        .sport-benchmarks { display: grid; gap: 0.3rem; }
        .sport-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 0.4rem;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid rgba(212,175,55,0.1);
            font-size: 0.75rem;
        }
        .sport-name { color: var(--bianco-ghiaccio); font-weight: 600; }
        .sport-level {
            text-align: center;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            min-width: 40px;
        }
        .level-avg { background: rgba(255,193,7,0.15); color: #FFC107; }
        .level-good { background: rgba(78,205,196,0.15); color: #4ECDC4; }
        .level-elite { background: rgba(212,175,55,0.2); color: var(--oro-runico); }

        /* Athlete Profile */
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
        }
        .profile-stat {
            background: var(--grigio-profondo);
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
        }
        .profile-stat.wide { grid-column: span 2; }
        .profile-stat-value {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            color: var(--oro-runico);
        }
        .profile-stat-label {
            font-size: 0.65rem;
            color: rgba(245,245,245,0.5);
            text-transform: uppercase;
            margin-top: 0.2rem;
        }
        .profile-stat-sub {
            font-size: 0.7rem;
            color: rgba(245,245,245,0.4);
        }
        .profile-empty {
            font-size: 0.85rem;
            color: rgba(245,245,245,0.5);
            text-align: center;
            padding: 1rem;
        }
        .profile-clear {
            margin-top: 0.8rem;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid rgba(255,107,107,0.3);
            border-radius: 6px;
            color: #FF6B6B;
            font-size: 0.75rem;
            cursor: pointer;
            width: 100%;
        }

        /* Athlete Inputs */
        .athlete-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        .input-group { }
        .input-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .athlete-input {
            flex: 1;
            padding: 0.8rem;
            background: var(--grigio-profondo);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 10px;
            color: var(--bianco-ghiaccio);
            font-size: 1rem;
            font-family: inherit;
            min-width: 0;
        }
        .athlete-input:focus {
            outline: none;
            border-color: var(--oro-runico);
        }
        .input-unit {
            color: rgba(245,245,245,0.5);
            font-size: 0.85rem;
            min-width: 25px;
        }

        /* Force-Power Profile */
        .fp-profile {
            margin-top: 1.2rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(212,175,55,0.03));
            border: 1px solid rgba(212,175,55,0.4);
            border-radius: 12px;
        }
        .fp-title {
            font-size: 0.8rem;
            color: var(--oro-runico);
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 0.8rem;
            text-align: center;
        }
        .fp-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .fp-metric {
            text-align: center;
            padding: 0.6rem 0.3rem;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .fp-metric-value {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--oro-runico);
        }
        .fp-metric-label {
            font-size: 0.6rem;
            color: rgba(245,245,245,0.5);
            text-transform: uppercase;
        }
        .fp-quadrant {
            background: var(--grigio-profondo);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }
        .fp-quadrant-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--bianco-ghiaccio);
            margin-bottom: 0.4rem;
        }
        .fp-quadrant-icon {
            font-size: 1.8rem;
            margin-bottom: 0.3rem;
        }
        .fp-quadrant-desc {
            font-size: 0.8rem;
            color: rgba(245,245,245,0.6);
            line-height: 1.4;
            margin-bottom: 0.8rem;
        }
        .fp-deficit {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: rgba(212,175,55,0.15);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--oro-runico);
            margin-bottom: 0.8rem;
        }
        .fp-cta {
            display: block;
            padding: 0.8rem;
            background: linear-gradient(135deg, var(--oro-runico), #B8963C);
            border-radius: 8px;
            color: var(--nero-carbone);
            text-decoration: none;
            font-weight: 700;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        .fp-cta:active { transform: scale(0.98); }

        /* Section Label */
        .section-label {
            font-size: 0.8rem;
            color: rgba(245,245,245,0.6);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
        }

        /* Jump Type */
        .jump-type-section { margin-bottom: 1rem; }
        .jump-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        .jump-type-btn {
            background: var(--grigio-profondo);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 10px;
            padding: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .jump-type-btn:active { transform: scale(0.97); }
        .jump-type-btn.selected {
            border-color: var(--oro-runico);
            background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05));
            box-shadow: 0 0 15px var(--oro-dim);
        }
        .jump-type-btn .type-name {
            font-weight: 700;
            color: var(--bianco-ghiaccio);
            font-size: 0.9rem;
        }
        .jump-type-btn.selected .type-name { color: var(--oro-runico); }
        .jump-type-btn .type-desc {
            font-size: 0.7rem;
            color: rgba(245,245,245,0.5);
            margin-top: 0.2rem;
        }
        .jump-type-note {
            font-size: 0.75rem;
            color: rgba(245,245,245,0.5);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            display: none;
        }
        .jump-type-note.visible { display: block; }

        /* Upload */
        .upload-zone {
            border: 2px dashed rgba(212,175,55,0.5);
            border-radius: 12px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            background: var(--grigio-profondo);
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        .upload-zone:active {
            transform: scale(0.98);
            border-color: var(--oro-runico);
        }
        .upload-icon { font-size: 3rem; margin-bottom: 0.8rem; }
        .upload-text { font-size: 1rem; font-weight: 600; }
        .upload-hint { font-size: 0.8rem; color: rgba(245,245,245,0.5); margin-top: 0.3rem; }
        input[type="file"] { display: none; }

        /* Video Section */
        .video-section { display: none; flex-direction: column; flex: 1; }
        .video-section.active { display: flex; }
        .video-wrapper {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        video {
            display: block;
            width: 100%;
            max-height: 35vh;
            object-fit: contain;
        }

        .scrubber-container {
            padding: 0.8rem 1rem;
            background: rgba(26,26,26,0.95);
            border-radius: 0 0 12px 12px;
            margin-top: -12px;
        }
        .frame-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.6rem;
        }
        .frame-info {
            font-family: 'Cinzel', serif;
            color: var(--oro-runico);
            font-size: 1.1rem;
        }
        .time-info { font-size: 0.85rem; color: rgba(245,245,245,0.6); }

        .scrubber {
            width: 100%;
            height: 44px;
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
        }
        .scrubber::-webkit-slider-runnable-track {
            height: 8px;
            background: var(--grigio-profondo);
            border-radius: 4px;
        }
        .scrubber::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: var(--oro-runico);
            border-radius: 50%;
            margin-top: -10px;
            box-shadow: 0 0 15px var(--oro-glow);
        }

        .video-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.6rem;
            margin-bottom: 1rem;
        }
        .ctrl-btn {
            background: var(--grigio-profondo);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 10px;
            color: var(--bianco-ghiaccio);
            padding: 0.9rem 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
        }
        .ctrl-btn:active { transform: scale(0.95); background: var(--oro-dim); }
        .ctrl-btn .icon { font-size: 1.3rem; }

        /* FPS Confirm */
        .fps-confirm-banner {
            display: none;
            background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05));
            border: 1px solid var(--oro-runico);
            border-radius: 10px;
            padding: 0.8rem;
            margin-bottom: 1rem;
        }
        .fps-confirm-banner.visible { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; } }
        .fps-confirm-text { font-size: 0.85rem; margin-bottom: 0.6rem; }
        .fps-confirm-text strong { color: var(--oro-runico); }
        .fps-confirm-buttons { display: flex; gap: 0.5rem; }
        .fps-confirm-btn {
            flex: 1;
            padding: 0.6rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }
        .fps-confirm-btn.confirm { background: var(--oro-runico); border: none; color: var(--nero-carbone); }
        .fps-confirm-btn.change { background: transparent; border: 1px solid rgba(245,245,245,0.3); color: rgba(245,245,245,0.8); }

        /* Mark Buttons */
        .mark-section { margin-bottom: 1rem; }
        .mark-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
        }
        .mark-buttons.three-marks {
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }
        .mark-btn {
            background: linear-gradient(135deg, var(--grigio-profondo), rgba(212,175,55,0.08));
            border: 2px solid rgba(212,175,55,0.4);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            text-align: center;
        }
        .mark-buttons.three-marks .mark-btn { padding: 0.7rem 0.5rem; }
        .mark-btn:active { transform: scale(0.97); }
        .mark-btn .label {
            display: block;
            font-size: 0.75rem;
            color: rgba(245,245,245,0.6);
            margin-bottom: 0.3rem;
            text-transform: uppercase;
        }
        .mark-buttons.three-marks .mark-btn .label { font-size: 0.65rem; }
        .mark-btn .frame-val {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: var(--oro-runico);
        }
        .mark-buttons.three-marks .mark-btn .frame-val { font-size: 1.1rem; }

        .mark-btn.cmstart-btn.marked { border-color: #F1C40F; box-shadow: 0 0 20px rgba(241,196,15,0.3); }
        .mark-btn.cmstart-btn.marked .frame-val { color: #F1C40F; }
        .mark-btn.contact-btn.marked { border-color: #9B59B6; box-shadow: 0 0 20px rgba(155,89,182,0.3); }
        .mark-btn.contact-btn.marked .frame-val { color: #9B59B6; }
        .mark-btn.takeoff-btn.marked { border-color: #FF6B6B; box-shadow: 0 0 20px rgba(255,107,107,0.3); }
        .mark-btn.takeoff-btn.marked .frame-val { color: #FF6B6B; }
        .mark-btn.landing-btn.marked { border-color: #4ECDC4; box-shadow: 0 0 20px rgba(78,205,196,0.3); }
        .mark-btn.landing-btn.marked .frame-val { color: #4ECDC4; }

        /* FPS Section */
        .fps-section { margin-bottom: 1rem; }
        .fps-row { display: flex; gap: 0.5rem; align-items: center; }
        .fps-select {
            flex: 1;
            padding: 0.9rem 1rem;
            background: var(--grigio-profondo);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 10px;
            color: var(--bianco-ghiaccio);
            font-family: inherit;
            font-size: 1rem;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='none' stroke='%23D4AF37' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }
        .fps-select:focus { outline: none; border-color: var(--oro-runico); }
        .fps-badge {
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .fps-badge.auto { background: linear-gradient(135deg, var(--oro-runico), #B8963C); color: var(--nero-carbone); }
        .fps-badge.manual { background: var(--grigio-profondo); border: 1px solid rgba(245,245,245,0.3); color: rgba(245,245,245,0.6); }
        .custom-fps-input {
            width: 100%;
            padding: 0.9rem 1rem;
            background: var(--grigio-profondo);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 10px;
            color: var(--bianco-ghiaccio);
            font-size: 1rem;
            margin-top: 0.5rem;
            display: none;
        }
        .custom-fps-input.visible { display: block; }

        .calculate-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, var(--oro-runico), #B8963C);
            border: none;
            border-radius: 12px;
            color: var(--nero-carbone);
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 900;
            letter-spacing: 0.15rem;
            cursor: pointer;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }
        .calculate-btn:active { transform: scale(0.98); }
        .calculate-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Results */
        .results {
            display: none;
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(212,175,55,0.12), rgba(212,175,55,0.03));
            border: 2px solid var(--oro-runico);
            border-radius: 16px;
            margin-bottom: 1rem;
        }
        .results.visible { display: block; animation: resultPop 0.4s cubic-bezier(0.175,0.885,0.32,1.275); }
        @keyframes resultPop { from { opacity: 0; transform: scale(0.9); } }

        .result-label {
            font-size: 0.75rem;
            color: rgba(245,245,245,0.5);
            text-transform: uppercase;
            letter-spacing: 0.15rem;
        }
        .result-value {
            font-family: 'Cinzel', serif;
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--oro-runico);
            text-shadow: 0 0 30px var(--oro-glow);
            line-height: 1;
        }
        .result-unit { font-size: 1.3rem; color: rgba(245,245,245,0.7); }
        .result-jump-type { font-size: 0.8rem; color: rgba(245,245,245,0.6); margin-top: 0.3rem; }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1.2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(212,175,55,0.2);
        }
        .result-stats.four-cols { grid-template-columns: repeat(4, 1fr); }
        .result-stats.five-cols { grid-template-columns: repeat(5, 1fr); }
        .stat-item { text-align: center; }
        .stat-value { font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--bianco-ghiaccio); }
        .result-stats.four-cols .stat-value,
        .result-stats.five-cols .stat-value { font-size: 1rem; }
        .stat-label { font-size: 0.65rem; color: rgba(245,245,245,0.5); text-transform: uppercase; }
        .result-stats.four-cols .stat-label,
        .result-stats.five-cols .stat-label { font-size: 0.55rem; }
        .stat-item.highlight .stat-value { color: var(--oro-runico); }

        .rating-badge {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1.2rem;
            background: var(--grigio-profondo);
            border: 1px solid var(--oro-runico);
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
        }

        /* Bosco Indices in Results */
        .bosco-indices {
            margin-top: 1rem;
            padding: 1rem;
            border: 2px solid var(--oro-runico);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05));
        }
        .bosco-indices.new-index {
            animation: pulseGold 0.6s ease;
        }
        @keyframes pulseGold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(212,175,55,0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(212,175,55,0.4); }
        }
        .bosco-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--oro-runico);
            text-transform: uppercase;
            margin-bottom: 0.8rem;
            text-align: center;
        }
        .bosco-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        .bosco-item {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 0.6rem;
            text-align: center;
        }
        .bosco-item.wide { grid-column: span 2; }
        .bosco-value {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--oro-runico);
        }
        .bosco-label {
            font-size: 0.6rem;
            color: rgba(245,245,245,0.5);
            text-transform: uppercase;
        }
        .bosco-interpretation {
            font-size: 0.65rem;
            color: rgba(245,245,245,0.4);
            margin-top: 0.2rem;
        }

        /* Share */
        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 1rem;
            margin-top: 1rem;
            background: linear-gradient(135deg, #E1306C, #C13584, #833AB4);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            cursor: pointer;
        }
        .share-btn:active { transform: scale(0.98); }

        /* Upsell */
        .upsell-section {
            margin-top: 1.2rem;
            padding-top: 1.2rem;
            border-top: 1px solid rgba(212,175,55,0.2);
        }
        .upsell-title {
            font-size: 0.75rem;
            color: rgba(245,245,245,0.5);
            text-transform: uppercase;
            margin-bottom: 0.8rem;
        }
        .upsell-cards { display: grid; gap: 0.8rem; }
        .upsell-card {
            display: block;
            background: var(--grigio-profondo);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 10px;
            padding: 1rem;
            text-decoration: none;
        }
        .upsell-card:active { transform: scale(0.98); border-color: var(--oro-runico); }
        .upsell-card-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.5rem; }
        .upsell-icon { font-size: 1.5rem; }
        .upsell-card-title { font-family: 'Cinzel', serif; color: var(--oro-runico); font-size: 0.95rem; font-weight: 700; }
        .upsell-card-desc { font-size: 0.8rem; color: rgba(245,245,245,0.7); line-height: 1.4; }
        .upsell-card-cta { display: inline-block; margin-top: 0.6rem; font-size: 0.75rem; color: var(--oro-runico); font-weight: 600; }

        /* Benchmarks */
        .benchmarks-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(212,175,55,0.2);
        }
        .benchmarks-title { font-size: 0.7rem; color: rgba(245,245,245,0.5); text-transform: uppercase; margin-bottom: 0.5rem; }
        .benchmark-bar {
            position: relative;
            height: 28px;
            background: var(--grigio-profondo);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 0.4rem;
        }
        .benchmark-fill {
            position: absolute;
            left: 0; top: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(212,175,55,0.3), rgba(212,175,55,0.1));
        }
        .benchmark-marker {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--oro-runico);
            box-shadow: 0 0 8px var(--oro-glow);
            z-index: 2;
        }
        .benchmark-labels {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0.5rem;
            font-size: 0.65rem;
            z-index: 1;
        }
        .benchmark-sport { color: var(--bianco-ghiaccio); font-weight: 600; }
        .benchmark-range { color: rgba(245,245,245,0.5); }

        .reset-btn {
            width: 100%;
            padding: 1rem;
            background: transparent;
            border: 1px solid rgba(245,245,245,0.25);
            border-radius: 10px;
            color: rgba(245,245,245,0.6);
            font-size: 0.95rem;
            cursor: pointer;
        }
        .reset-btn:active { background: rgba(245,245,245,0.05); }

        .method-info {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: rgba(245,245,245,0.5);
            line-height: 1.5;
        }
        .method-info code {
            color: var(--oro-runico);
            background: rgba(212,175,55,0.1);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
        }

        footer { text-align: center; padding: 1.5rem 0 1rem; margin-top: auto; }
        .footer-brand { font-family: 'Cinzel', serif; color: var(--oro-runico); font-size: 0.75rem; letter-spacing: 0.15rem; }
        .footer-rune { color: var(--oro-runico); letter-spacing: 0.25rem; font-size: 0.8rem; margin-top: 0.2rem; }

        #share-canvas { display: none; }

        .install-prompt {
            display: none;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            padding: 1rem;
            padding-bottom: calc(1rem + var(--safe-bottom));
            background: linear-gradient(to top, var(--grigio-profondo), rgba(26,26,26,0.95));
            border-top: 1px solid rgba(212,175,55,0.3);
            z-index: 100;
        }
        .install-prompt.visible { display: block; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } }
        .install-content { display: flex; align-items: center; gap: 1rem; max-width: 500px; margin: 0 auto; }
        .install-icon { font-size: 2rem; }
        .install-text { flex: 1; }
        .install-text strong { display: block; color: var(--bianco-ghiaccio); }
        .install-text span { font-size: 0.8rem; color: rgba(245,245,245,0.6); }
        .install-close { background: none; border: none; color: rgba(245,245,245,0.5); font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo-rune">·ö∫ ·õü ·õà ·õà</div>
            <h1>H«™PP</h1>
            <p class="subtitle">Flight Time Jump Analysis</p>
        </header>

        <main>
            <!-- Athlete Profile Box -->
            <div class="info-box" id="profile-box">
                <div class="info-header" onclick="toggleInfo('profile-box')">
                    <div class="info-title">
                        <span>üë§</span> Profilo Atleta <span id="profile-badge" style="display:none;background:var(--oro-runico);color:#000;padding:0.15rem 0.5rem;border-radius:10px;font-size:0.65rem;margin-left:0.5rem;">INDICI</span>
                    </div>
                    <span class="info-toggle">‚ñº</span>
                </div>
                <div class="info-content">
                    <div class="info-inner">
                        <div id="profile-content">
                            <p class="profile-empty">Esegui alcuni test per vedere il tuo profilo</p>
                        </div>
                        <button class="profile-clear" id="clear-profile" style="display:none;">üóëÔ∏è Reset Storico</button>
                    </div>
                </div>
            </div>

            <!-- Tips -->
            <div class="info-box" id="tips-box">
                <div class="info-header" onclick="toggleInfo('tips-box')">
                    <div class="info-title"><span>üìπ</span> Come Filmare</div>
                    <span class="info-toggle">‚ñº</span>
                </div>
                <div class="info-content">
                    <div class="info-inner">
                        <div class="info-section">
                            <h4>üéØ FPS e Precisione</h4>
                            <table class="fps-table">
                                <tr><th>FPS</th><th>Errore</th><th>Livello</th></tr>
                                <tr><td>30</td><td>¬±4-5 cm</td><td><span class="accuracy-badge accuracy-low">Bassa</span></td></tr>
                                <tr><td>60</td><td>¬±2-3 cm</td><td><span class="accuracy-badge accuracy-med">Media</span></td></tr>
                                <tr><td>120</td><td>¬±1-1.5 cm</td><td><span class="accuracy-badge accuracy-high">Alta</span></td></tr>
                                <tr><td>240</td><td>¬±0.5 cm</td><td><span class="accuracy-badge accuracy-max">Max</span></td></tr>
                            </table>
                        </div>
                        <div class="info-section">
                            <h4>üì± iPhone Slow-Mo</h4>
                            <ul>
                                <li>Impostazioni ‚Üí Fotocamera ‚Üí Slow-mo</li>
                                <li>Seleziona <strong>240 fps</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Benchmarks -->
            <div class="info-box" id="benchmarks-box">
                <div class="info-header" onclick="toggleInfo('benchmarks-box')">
                    <div class="info-title"><span>üèÜ</span> Benchmark CMJ</div>
                    <span class="info-toggle">‚ñº</span>
                </div>
                <div class="info-content">
                    <div class="info-inner">
                        <div class="sport-benchmarks" id="benchmark-list"></div>
                        <div class="tip-highlight" style="margin-top:0.8rem">üìä Valori cm, atleti maschi adulti</div>
                    </div>
                </div>
            </div>

            <!-- Weight & Squat Inputs -->
            <div class="athlete-inputs">
                <div class="input-group">
                    <div class="section-label">Peso Corporeo</div>
                    <div class="input-row">
                        <input type="number" class="athlete-input" id="weight-input" placeholder="75" min="30" max="200" step="0.1">
                        <span class="input-unit">kg</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="section-label">Squat 1RM</div>
                    <div class="input-row">
                        <input type="number" class="athlete-input" id="squat-input" placeholder="120" min="20" max="400" step="1">
                        <span class="input-unit">kg</span>
                    </div>
                </div>
            </div>

            <!-- Jump Type -->
            <div class="jump-type-section">
                <div class="section-label">Tipo di Salto</div>
                <div class="jump-type-grid">
                    <button class="jump-type-btn selected" data-type="CMJ">
                        <div class="type-name">CMJ</div>
                        <div class="type-desc">Counter Movement</div>
                    </button>
                    <button class="jump-type-btn" data-type="SJ">
                        <div class="type-name">SJ</div>
                        <div class="type-desc">Squat Jump</div>
                    </button>
                    <button class="jump-type-btn" data-type="DJ">
                        <div class="type-name">DJ</div>
                        <div class="type-desc">Drop Jump + RSI</div>
                    </button>
                    <button class="jump-type-btn" data-type="ABALAKOV">
                        <div class="type-name">Abalakov</div>
                        <div class="type-desc">CMJ + braccia</div>
                    </button>
                </div>
                <div class="jump-type-note" id="jump-type-note"></div>
            </div>

            <!-- Upload -->
            <div id="upload-zone" class="upload-zone">
                <div class="upload-icon">üé¨</div>
                <p class="upload-text">Carica Video del Salto</p>
                <p class="upload-hint">MP4, MOV, WEBM</p>
                <input type="file" id="video-input" accept="video/*">
            </div>

            <!-- Video Section -->
            <div id="video-section" class="video-section">
                <div class="video-wrapper">
                    <video id="video-player" playsinline muted></video>
                </div>

                <div class="scrubber-container">
                    <div class="frame-display">
                        <span class="frame-info">Frame <span id="current-frame">0</span></span>
                        <span class="time-info"><span id="current-time">0.000</span>s</span>
                    </div>
                    <input type="range" class="scrubber" id="scrubber" min="0" max="100" value="0">
                </div>

                <div class="video-controls">
                    <button class="ctrl-btn" id="prev-frame"><span class="icon">‚óÄ‚óÄ</span><span>-1</span></button>
                    <button class="ctrl-btn" id="play-pause"><span class="icon" id="play-icon">‚ñ∂</span><span id="play-text">Play</span></button>
                    <button class="ctrl-btn" id="next-frame"><span class="icon">‚ñ∂‚ñ∂</span><span>+1</span></button>
                </div>

                <div class="fps-confirm-banner" id="fps-confirm-banner">
                    <div class="fps-confirm-text">FPS rilevato: <strong id="fps-detected-value">30</strong></div>
                    <div class="fps-confirm-buttons">
                        <button class="fps-confirm-btn confirm" id="fps-confirm-yes">‚úì Conferma</button>
                        <button class="fps-confirm-btn change" id="fps-confirm-no">Cambia</button>
                    </div>
                </div>

                <div class="mark-section">
                    <div class="mark-buttons" id="mark-buttons">
                        <button class="mark-btn takeoff-btn" id="mark-takeoff">
                            <span class="label">üî¥ Takeoff</span>
                            <span class="frame-val" id="takeoff-frame">--</span>
                        </button>
                        <button class="mark-btn landing-btn" id="mark-landing">
                            <span class="label">üîµ Landing</span>
                            <span class="frame-val" id="landing-frame">--</span>
                        </button>
                    </div>
                </div>

                <div class="fps-section">
                    <div class="section-label">Frame Rate</div>
                    <div class="fps-row">
                        <select class="fps-select" id="fps-select">
                            <option value="30">30 FPS</option>
                            <option value="60">60 FPS</option>
                            <option value="120">120 FPS</option>
                            <option value="240">240 FPS</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <div class="fps-badge manual" id="fps-badge">MANUALE</div>
                    </div>
                    <input type="number" class="custom-fps-input" id="custom-fps" placeholder="FPS" min="1" max="1000">
                </div>

                <button class="calculate-btn" id="calculate-btn" disabled>Calcola</button>

                <div class="results" id="results">
                    <div class="result-label">Altezza Salto</div>
                    <div class="result-value"><span id="result-cm">0</span><span class="result-unit">cm</span></div>
                    <div class="result-jump-type" id="result-jump-type">CMJ</div>
                    <div class="result-stats" id="result-stats"></div>
                    <div class="rating-badge" id="rating">-</div>

                    <!-- Bosco Indices -->
                    <div class="bosco-indices" id="bosco-indices" style="display:none">
                        <div class="bosco-title">üß™ Indici Bosco Calcolati</div>
                        <div class="bosco-grid" id="bosco-grid"></div>
                    </div>

                    <button class="share-btn" id="share-btn">üì∏ Condividi</button>

                    <!-- Force-Power Profile -->
                    <div class="fp-profile" id="fp-profile" style="display:none">
                        <div class="fp-title">üí™ Profilo Forza-Potenza</div>
                        <div class="fp-metrics">
                            <div class="fp-metric">
                                <div class="fp-metric-value" id="fp-rel-str">--</div>
                                <div class="fp-metric-label">Forza Rel.</div>
                            </div>
                            <div class="fp-metric">
                                <div class="fp-metric-value" id="fp-cmj">--</div>
                                <div class="fp-metric-label">CMJ</div>
                            </div>
                            <div class="fp-metric">
                                <div class="fp-metric-value" id="fp-power">--</div>
                                <div class="fp-metric-label">Potenza</div>
                            </div>
                        </div>
                        <div class="fp-quadrant">
                            <div class="fp-quadrant-icon" id="fp-icon">üéØ</div>
                            <div class="fp-quadrant-name" id="fp-quadrant-name">--</div>
                            <div class="fp-deficit" id="fp-deficit" style="display:none"></div>
                            <div class="fp-quadrant-desc" id="fp-quadrant-desc">Inserisci peso e Squat 1RM per l'analisi</div>
                            <a href="https://www.preparazioneatletica.com/" target="_blank" class="fp-cta">üöÄ Scopri Performance A.I.</a>
                        </div>
                    </div>

                    <div class="benchmarks-section" id="benchmarks-section">
                        <div class="benchmarks-title">Confronto Sport (CMJ)</div>
                        <div id="benchmark-bars"></div>
                    </div>
                </div>

                <button class="reset-btn" id="reset-btn">‚Üª Nuovo Test</button>

                <div class="method-info">
                    Analisi basata sul metodo flight time, gold standard della biomeccanica sportiva.
                </div>
            </div>
        </main>

        <footer>
            <div class="footer-brand">NICHOLAS RUBINI</div>
            <div class="footer-rune">·õü ·öπ ·õÅ ·öæ ·öæ</div>
        </footer>
    </div>

    <canvas id="share-canvas" width="1080" height="1920"></canvas>

    <div class="install-prompt" id="install-prompt">
        <div class="install-content">
            <div class="install-icon">üì≤</div>
            <div class="install-text">
                <strong>Installa H«™PP</strong>
                <span>Condividi ‚Üí Aggiungi a Home</span>
            </div>
            <button class="install-close" id="install-close">√ó</button>
        </div>
    </div>

    <script>
        // ============================================
        // DATA
        // ============================================
        const SPORT_BENCHMARKS = {
            'Basket': { emoji: 'üèÄ', avg: 50, good: 65, elite: 75 },
            'Pallavolo': { emoji: 'üèê', avg: 45, good: 60, elite: 70 },
            'Calcio': { emoji: '‚öΩ', avg: 40, good: 50, elite: 60 },
            'Atletica': { emoji: 'üèÉ', avg: 55, good: 70, elite: 80 },
            'Football': { emoji: 'üèà', avg: 50, good: 65, elite: 80 },
            'MMA': { emoji: 'ü•ã', avg: 45, good: 55, elite: 65 },
            'Kickboxing': { emoji: 'ü¶µ', avg: 45, good: 55, elite: 65 },
            'Taekwondo': { emoji: 'ü•ã', avg: 50, good: 60, elite: 70 }
        };

        const jumpTypeInfo = {
            'CMJ': { name: 'Counter Movement Jump', note: 'Marca: Inizio discesa ‚Üí Takeoff ‚Üí Landing. Braccia ai fianchi.', markers: 3 },
            'SJ': { name: 'Squat Jump', note: 'Partenza statica da 90¬∞, nessun contromovimento.', markers: 2 },
            'DJ': { name: 'Drop Jump', note: 'Caduta da box + salto reattivo. Marca: Contact ‚Üí Takeoff ‚Üí Landing.', markers: 3 },
            'ABALAKOV': { name: 'Abalakov', note: 'CMJ con slancio braccia. Marca: Inizio discesa ‚Üí Takeoff ‚Üí Landing.', markers: 3 }
        };

        // ============================================
        // STATE
        // ============================================
        let videoFps = 30;
        let fpsConfirmed = false;
        let takeoffFrame = null;
        let landingFrame = null;
        let contactFrame = null;  // For DJ (ground contact)
        let cmStartFrame = null;  // For CMJ/Abalakov (countermovement start)
        let selectedJumpType = 'CMJ';
        let lastResult = { cm: 0, flightTime: 0, contactTime: null, rsi: null, stiffness: null, power: null, rsiMod: null, cmTime: null };

        // Load stored data
        let athleteData = JSON.parse(localStorage.getItem('hopp_athlete') || '{}');
        let jumpHistory = JSON.parse(localStorage.getItem('hopp_history') || '{}');

        // ============================================
        // DOM
        // ============================================
        const $ = id => document.getElementById(id);

        // ============================================
        // INIT
        // ============================================
        function init() {
            generateBenchmarkList();
            
            // Load saved weight and squat
            if (athleteData.weight) {
                $('weight-input').value = athleteData.weight;
            }
            if (athleteData.squat1rm) {
                $('squat-input').value = athleteData.squat1rm;
            }
            
            // Calculate FP profile from saved data if available
            updateSavedForcePowerProfile();
            
            // Load athlete profile (after FP calculation)
            loadAthleteProfile();

            // Service Worker
            if ('serviceWorker' in navigator) {
                const sw = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))));`;
                navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], {type:'application/javascript'}))).catch(()=>{});
            }

            // iOS install prompt
            if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.navigator.standalone && !localStorage.getItem('hopp-dismissed')) {
                setTimeout(() => $('install-prompt').classList.add('visible'), 3000);
            }
        }

        function generateBenchmarkList() {
            $('benchmark-list').innerHTML = Object.entries(SPORT_BENCHMARKS).map(([sport, d]) => `
                <div class="sport-row">
                    <span class="sport-name">${d.emoji} ${sport}</span>
                    <span class="sport-level level-avg">${d.avg}+</span>
                    <span class="sport-level level-good">${d.good}+</span>
                    <span class="sport-level level-elite">${d.elite}+</span>
                </div>
            `).join('');
        }

        // ============================================
        // ATHLETE PROFILE
        // ============================================
        // Helper to get height value (handles both old format: number, and new format: {height, rsiMod, ...})
        function getJumpHeight(jump) {
            if (!jump) return null;
            return typeof jump === 'object' ? jump.height : jump;
        }
        
        function loadAthleteProfile() {
            const hasData = jumpHistory.CMJ || jumpHistory.SJ || jumpHistory.ABALAKOV || jumpHistory.DJ;
            const cmjH = getJumpHeight(jumpHistory.CMJ);
            const sjH = getJumpHeight(jumpHistory.SJ);
            const abaH = getJumpHeight(jumpHistory.ABALAKOV);
            const hasIndices = (cmjH && sjH) || (cmjH && abaH);
            const hasFPProfile = athleteData.quadrant && athleteData.relativeStrength;
            
            // Show/hide badge
            $('profile-badge').style.display = (hasIndices || hasFPProfile) ? 'inline' : 'none';
            
            if (!hasData) {
                $('profile-content').innerHTML = '<p class="profile-empty">Esegui alcuni test per vedere il tuo profilo</p>';
                $('clear-profile').style.display = 'none';
                $('profile-box').classList.remove('open');
                return;
            }

            // Auto-open profile when there's data, especially indices or FP profile
            if (hasIndices || hasFPProfile) {
                $('profile-box').classList.add('open');
            }
            
            $('clear-profile').style.display = 'block';
            
            let html = '<div class="profile-grid">';
            
            // Show stored jumps
            if (cmjH) html += profileStat(cmjH, 'CMJ', 'cm');
            if (sjH) html += profileStat(sjH, 'SJ', 'cm');
            if (abaH) html += profileStat(abaH, 'Abalakov', 'cm');
            if (jumpHistory.DJ) html += profileStat(jumpHistory.DJ.height, 'DJ', 'cm');
            
            // RSI-mod for CMJ
            if (jumpHistory.CMJ && typeof jumpHistory.CMJ === 'object' && jumpHistory.CMJ.rsiMod) {
                const rsiModInt = jumpHistory.CMJ.rsiMod >= 0.6 ? '√âlite' : jumpHistory.CMJ.rsiMod >= 0.45 ? 'Buono' : jumpHistory.CMJ.rsiMod >= 0.35 ? 'Medio' : 'Base';
                html += `<div class="profile-stat">
                    <div class="profile-stat-value">${jumpHistory.CMJ.rsiMod.toFixed(2)}</div>
                    <div class="profile-stat-label">RSI-mod (CMJ)</div>
                    <div class="profile-stat-sub">${rsiModInt}</div>
                </div>`;
            }
            
            // Derived indices
            if (cmjH && sjH) {
                const ie = ((cmjH - sjH) / sjH * 100).toFixed(1);
                const ieInterpret = ie >= 15 ? 'Ottima elasticit√†' : ie >= 10 ? 'Buona' : 'Deficit SSC';
                html += `<div class="profile-stat">
                    <div class="profile-stat-value">${ie}%</div>
                    <div class="profile-stat-label">Indice Elasticit√†</div>
                    <div class="profile-stat-sub">${ieInterpret}</div>
                </div>`;
            }
            
            if (cmjH && abaH) {
                const icb = ((abaH - cmjH) / cmjH * 100).toFixed(1);
                const icbInterpret = icb >= 12 ? 'Ottima coord.' : icb >= 8 ? 'Buona' : 'Da migliorare';
                html += `<div class="profile-stat">
                    <div class="profile-stat-value">${icb}%</div>
                    <div class="profile-stat-label">Indice Coord. Braccia</div>
                    <div class="profile-stat-sub">${icbInterpret}</div>
                </div>`;
            }
            
            if (jumpHistory.DJ && jumpHistory.DJ.rsi) {
                const rsiInterpret = jumpHistory.DJ.rsi >= 2.5 ? '√âlite' : jumpHistory.DJ.rsi >= 2.0 ? 'Buono' : jumpHistory.DJ.rsi >= 1.5 ? 'Medio' : 'Da migliorare';
                html += `<div class="profile-stat">
                    <div class="profile-stat-value">${jumpHistory.DJ.rsi.toFixed(2)}</div>
                    <div class="profile-stat-label">RSI (Drop Jump)</div>
                    <div class="profile-stat-sub">${rsiInterpret}</div>
                </div>`;
            }
            
            if (athleteData.lastPower) {
                html += `<div class="profile-stat">
                    <div class="profile-stat-value">${athleteData.lastPower}</div>
                    <div class="profile-stat-label">Potenza (W)</div>
                </div>`;
            }
            
            // Force-Power Profile
            if (athleteData.relativeStrength) {
                html += `<div class="profile-stat">
                    <div class="profile-stat-value">${athleteData.relativeStrength.toFixed(2)}x</div>
                    <div class="profile-stat-label">Forza Relativa</div>
                    <div class="profile-stat-sub">Squat/BW</div>
                </div>`;
            }
            
            if (athleteData.quadrant) {
                html += `<div class="profile-stat wide">
                    <div class="profile-stat-value" style="font-size:0.9rem">${athleteData.quadrant}</div>
                    <div class="profile-stat-label">Profilo Forza-Potenza</div>
                </div>`;
            }
            
            // Show FP analysis prompt if we have CMJ but missing squat
            if (cmjH && athleteData.weight && !athleteData.squat1rm) {
                html += `<div class="profile-stat wide" style="background:rgba(212,175,55,0.1)">
                    <div class="profile-stat-value" style="font-size:0.8rem;color:var(--oro-runico)">üí™ Inserisci Squat 1RM</div>
                    <div class="profile-stat-label">Per sbloccare il Profilo Forza-Potenza</div>
                </div>`;
            }
            
            html += '</div>';
            $('profile-content').innerHTML = html;
        }
        
        // Update Force-Power profile using saved data (not from current test)
        function updateSavedForcePowerProfile() {
            const weight = athleteData.weight;
            const squat = athleteData.squat1rm;
            const cmjH = getJumpHeight(jumpHistory.CMJ);
            
            if (!weight || !squat || !cmjH) return;
            
            // Calculate metrics
            const relStr = squat / weight;
            const power = Math.round(60.7 * cmjH + 45.3 * weight - 2055);
            
            // Expected CMJ based on relative strength
            const expectedCMJ = 18 + (relStr * 18);
            const deficit = expectedCMJ - cmjH;
            
            // Determine quadrant
            const isStrong = relStr >= 1.5;
            const isExplosive = cmjH >= 45;
            
            let quadrant;
            if (isStrong && isExplosive) {
                quadrant = 'Atleta Completo';
            } else if (isStrong && !isExplosive) {
                quadrant = 'Deficit di Potenza';
            } else if (!isStrong && isExplosive) {
                quadrant = 'Potenziale Inespresso';
            } else {
                quadrant = 'Costruisci le Basi';
            }
            
            // Save to athlete data
            athleteData.relativeStrength = relStr;
            athleteData.quadrant = quadrant;
            athleteData.lastPower = power;
            athleteData.fpDeficit = deficit;
            localStorage.setItem('hopp_athlete', JSON.stringify(athleteData));
        }

        function profileStat(value, label, unit) {
            return `<div class="profile-stat">
                <div class="profile-stat-value">${value.toFixed ? value.toFixed(1) : value}${unit}</div>
                <div class="profile-stat-label">${label}</div>
            </div>`;
        }

        function saveJumpToHistory(type, heightCm, extraData = {}) {
            if (type === 'DJ' || type === 'CMJ' || type === 'ABALAKOV') {
                jumpHistory[type] = { height: heightCm, ...extraData };
            } else {
                jumpHistory[type] = heightCm;
            }
            localStorage.setItem('hopp_history', JSON.stringify(jumpHistory));
            loadAthleteProfile();
        }

        $('clear-profile').addEventListener('click', () => {
            if (confirm('Reset tutto lo storico?')) {
                jumpHistory = {};
                athleteData = {};
                localStorage.removeItem('hopp_history');
                localStorage.removeItem('hopp_athlete');
                $('weight-input').value = '';
                $('squat-input').value = '';
                loadAthleteProfile();
            }
        });

        // ============================================
        // ATHLETE INPUTS (Weight & Squat)
        // ============================================
        $('weight-input').addEventListener('change', () => {
            const w = parseFloat($('weight-input').value);
            if (w > 0) {
                athleteData.weight = w;
                localStorage.setItem('hopp_athlete', JSON.stringify(athleteData));
                // Recalculate force-power profile
                updateSavedForcePowerProfile();
                loadAthleteProfile();
            }
        });

        $('squat-input').addEventListener('change', () => {
            const s = parseFloat($('squat-input').value);
            if (s > 0) {
                athleteData.squat1rm = s;
                localStorage.setItem('hopp_athlete', JSON.stringify(athleteData));
                // Recalculate force-power profile with saved CMJ data
                updateSavedForcePowerProfile();
                loadAthleteProfile();
            }
        });

        // ============================================
        // TOGGLE INFO
        // ============================================
        function toggleInfo(id) { $(id).classList.toggle('open'); }

        // ============================================
        // JUMP TYPE
        // ============================================
        document.querySelectorAll('.jump-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.jump-type-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedJumpType = btn.dataset.type;
                updateJumpTypeUI();
            });
        });

        function updateJumpTypeUI() {
            const info = jumpTypeInfo[selectedJumpType];
            $('jump-type-note').textContent = info.note;
            $('jump-type-note').classList.add('visible');
            
            const mb = $('mark-buttons');
            if (selectedJumpType === 'DJ') {
                mb.classList.add('three-marks');
                mb.innerHTML = `
                    <button class="mark-btn contact-btn" id="mark-contact"><span class="label">üü£ Contact</span><span class="frame-val" id="contact-frame">--</span></button>
                    <button class="mark-btn takeoff-btn" id="mark-takeoff"><span class="label">üî¥ Takeoff</span><span class="frame-val" id="takeoff-frame">--</span></button>
                    <button class="mark-btn landing-btn" id="mark-landing"><span class="label">üîµ Landing</span><span class="frame-val" id="landing-frame">--</span></button>
                `;
            } else if (selectedJumpType === 'CMJ' || selectedJumpType === 'ABALAKOV') {
                mb.classList.add('three-marks');
                mb.innerHTML = `
                    <button class="mark-btn cmstart-btn" id="mark-cmstart"><span class="label">üü° Start</span><span class="frame-val" id="cmstart-frame">--</span></button>
                    <button class="mark-btn takeoff-btn" id="mark-takeoff"><span class="label">üî¥ Takeoff</span><span class="frame-val" id="takeoff-frame">--</span></button>
                    <button class="mark-btn landing-btn" id="mark-landing"><span class="label">üîµ Landing</span><span class="frame-val" id="landing-frame">--</span></button>
                `;
            } else {
                // SJ: only 2 markers
                mb.classList.remove('three-marks');
                mb.innerHTML = `
                    <button class="mark-btn takeoff-btn" id="mark-takeoff"><span class="label">üî¥ Takeoff</span><span class="frame-val" id="takeoff-frame">--</span></button>
                    <button class="mark-btn landing-btn" id="mark-landing"><span class="label">üîµ Landing</span><span class="frame-val" id="landing-frame">--</span></button>
                `;
            }
            attachMarkListeners();
            takeoffFrame = landingFrame = contactFrame = cmStartFrame = null;
            checkReady();
        }

        function attachMarkListeners() {
            $('mark-takeoff')?.addEventListener('click', () => {
                takeoffFrame = getCurrentFrame();
                $('takeoff-frame').textContent = takeoffFrame;
                $('mark-takeoff').classList.add('marked');
                checkReady();
                navigator.vibrate?.(50);
            });
            $('mark-landing')?.addEventListener('click', () => {
                landingFrame = getCurrentFrame();
                $('landing-frame').textContent = landingFrame;
                $('mark-landing').classList.add('marked');
                checkReady();
                navigator.vibrate?.(50);
            });
            $('mark-contact')?.addEventListener('click', () => {
                contactFrame = getCurrentFrame();
                $('contact-frame').textContent = contactFrame;
                $('mark-contact').classList.add('marked');
                checkReady();
                navigator.vibrate?.(50);
            });
            $('mark-cmstart')?.addEventListener('click', () => {
                cmStartFrame = getCurrentFrame();
                $('cmstart-frame').textContent = cmStartFrame;
                $('mark-cmstart').classList.add('marked');
                checkReady();
                navigator.vibrate?.(50);
            });
        }
        attachMarkListeners();

        function checkReady() {
            if (selectedJumpType === 'DJ') {
                $('calculate-btn').disabled = !(contactFrame !== null && takeoffFrame !== null && landingFrame !== null && contactFrame < takeoffFrame && takeoffFrame < landingFrame);
            } else if (selectedJumpType === 'CMJ' || selectedJumpType === 'ABALAKOV') {
                $('calculate-btn').disabled = !(cmStartFrame !== null && takeoffFrame !== null && landingFrame !== null && cmStartFrame < takeoffFrame && takeoffFrame < landingFrame);
            } else {
                // SJ
                $('calculate-btn').disabled = !(takeoffFrame !== null && landingFrame !== null && landingFrame > takeoffFrame);
            }
        }

        // ============================================
        // VIDEO
        // ============================================
        $('upload-zone').addEventListener('click', () => $('video-input').click());
        $('video-input').addEventListener('change', e => { if (e.target.files.length) loadVideo(e.target.files[0]); });

        async function loadVideo(file) {
            const vp = $('video-player');
            vp.src = URL.createObjectURL(file);
            vp.addEventListener('loadedmetadata', async () => {
                $('upload-zone').style.display = 'none';
                $('video-section').classList.add('active');
                fpsConfirmed = false;
                $('fps-badge').textContent = 'MANUALE';
                $('fps-badge').className = 'fps-badge manual';
                $('fps-confirm-banner').classList.remove('visible');
                await attemptFpsDetection();
                $('scrubber').max = vp.duration;
                $('scrubber').step = 1 / videoFps;
                vp.pause();
                vp.currentTime = 0;
                updateDisplay();
            }, { once: true });
        }

        async function attemptFpsDetection() {
            if (!('requestVideoFrameCallback' in HTMLVideoElement.prototype)) return;
            try {
                const detected = await detectFps();
                if (detected && detected >= 15 && detected <= 300) {
                    const common = [24,25,30,60,120,240];
                    let fps = detected;
                    for (const c of common) if (Math.abs(detected - c) <= 3) { fps = c; break; }
                    $('fps-detected-value').textContent = fps + ' FPS';
                    $('fps-confirm-banner').classList.add('visible');
                    const opt = Array.from($('fps-select').options).find(o => +o.value === fps);
                    if (opt) $('fps-select').value = fps; else { $('fps-select').value = 'custom'; $('custom-fps').value = fps; $('custom-fps').classList.add('visible'); }
                    videoFps = fps;
                }
            } catch(e) {}
        }

        function detectFps() {
            return new Promise(resolve => {
                const vp = $('video-player');
                const ts = [];
                let n = 0, done = false;
                const cb = (now, meta) => {
                    if (done) return;
                    ts.push(meta.mediaTime);
                    if (++n >= 15) {
                        done = true;
                        vp.pause();
                        vp.currentTime = 0;
                        const deltas = [];
                        for (let i = 1; i < ts.length; i++) { const d = ts[i] - ts[i-1]; if (d > 0 && d < 0.2) deltas.push(d); }
                        if (deltas.length >= 5) { deltas.sort((a,b) => a-b); resolve(Math.round(1 / deltas[Math.floor(deltas.length/2)])); }
                        else resolve(null);
                        return;
                    }
                    vp.requestVideoFrameCallback(cb);
                };
                vp.currentTime = 0;
                vp.requestVideoFrameCallback(cb);
                vp.muted = true;
                vp.play()?.catch(() => { done = true; resolve(null); });
                setTimeout(() => { if (!done) { done = true; vp.pause(); vp.currentTime = 0; resolve(null); } }, 2000);
            });
        }

        $('fps-confirm-yes').addEventListener('click', () => {
            fpsConfirmed = true;
            $('fps-badge').textContent = 'AUTO';
            $('fps-badge').className = 'fps-badge auto';
            $('fps-confirm-banner').classList.remove('visible');
            $('scrubber').step = 1 / videoFps;
        });
        $('fps-confirm-no').addEventListener('click', () => { $('fps-confirm-banner').classList.remove('visible'); $('fps-select').focus(); });

        // Controls
        const getCurrentFrame = () => Math.round($('video-player').currentTime * videoFps);
        function updateDisplay() {
            $('current-frame').textContent = getCurrentFrame();
            $('current-time').textContent = $('video-player').currentTime.toFixed(3);
            $('scrubber').value = $('video-player').currentTime;
        }
        $('video-player').addEventListener('timeupdate', updateDisplay);
        $('scrubber').addEventListener('input', () => { $('video-player').currentTime = +$('scrubber').value; updateDisplay(); });

        $('play-pause').addEventListener('click', () => {
            const vp = $('video-player');
            if (vp.paused) { vp.play(); $('play-icon').textContent = '‚è∏'; $('play-text').textContent = 'Pause'; }
            else { vp.pause(); $('play-icon').textContent = '‚ñ∂'; $('play-text').textContent = 'Play'; }
        });
        $('video-player').addEventListener('pause', () => { $('play-icon').textContent = '‚ñ∂'; $('play-text').textContent = 'Play'; });
        $('video-player').addEventListener('play', () => { $('play-icon').textContent = '‚è∏'; $('play-text').textContent = 'Pause'; });

        function stepFrame(d) { const vp = $('video-player'); vp.pause(); vp.currentTime = Math.max(0, Math.min(vp.duration, vp.currentTime + d/videoFps)); updateDisplay(); }
        $('prev-frame').addEventListener('click', () => stepFrame(-1));
        $('next-frame').addEventListener('click', () => stepFrame(1));
        let stepInt;
        $('prev-frame').addEventListener('touchstart', e => { e.preventDefault(); stepFrame(-1); stepInt = setInterval(() => stepFrame(-1), 100); });
        $('prev-frame').addEventListener('touchend', () => clearInterval(stepInt));
        $('next-frame').addEventListener('touchstart', e => { e.preventDefault(); stepFrame(1); stepInt = setInterval(() => stepFrame(1), 100); });
        $('next-frame').addEventListener('touchend', () => clearInterval(stepInt));

        // FPS select
        $('fps-select').addEventListener('change', () => {
            fpsConfirmed = false;
            $('fps-badge').textContent = 'MANUALE';
            $('fps-badge').className = 'fps-badge manual';
            if ($('fps-select').value === 'custom') { $('custom-fps').classList.add('visible'); $('custom-fps').focus(); }
            else { $('custom-fps').classList.remove('visible'); videoFps = +$('fps-select').value; $('scrubber').step = 1/videoFps; updateDisplay(); }
        });
        $('custom-fps').addEventListener('input', () => { const v = +$('custom-fps').value; if (v > 0) { videoFps = v; $('scrubber').step = 1/videoFps; updateDisplay(); } });

        // ============================================
        // CALCULATE
        // ============================================
        $('calculate-btn').addEventListener('click', calculate);

        function calculate() {
            const flightFrames = landingFrame - takeoffFrame;
            const flightTime = flightFrames / videoFps;
            const h = (9.81 * flightTime * flightTime) / 8 * 100;
            
            lastResult = { cm: h, flightTime };

            // For DJ: contact time, RSI, Stiffness
            if (selectedJumpType === 'DJ') {
                const ctFrames = takeoffFrame - contactFrame;
                const ct = ctFrames / videoFps;
                lastResult.contactTime = ct;
                lastResult.rsi = (h / 100) / ct;
                lastResult.stiffness = (Math.PI * (flightTime + ct)) / (ct * ct);
            }
            
            // For CMJ/Abalakov: RSI-mod (countermovement time)
            if (selectedJumpType === 'CMJ' || selectedJumpType === 'ABALAKOV') {
                const cmFrames = takeoffFrame - cmStartFrame;
                const cmTime = cmFrames / videoFps;
                lastResult.cmTime = cmTime;
                lastResult.rsiMod = (h / 100) / cmTime;  // RSI-mod = height(m) / countermovement time(s)
            }

            // Power (Sayers formula)
            const weight = parseFloat($('weight-input').value);
            if (weight > 0) {
                lastResult.power = Math.round(60.7 * h + 45.3 * weight - 2055);
                athleteData.lastPower = lastResult.power;
                localStorage.setItem('hopp_athlete', JSON.stringify(athleteData));
            }

            // Save to history
            if (selectedJumpType === 'DJ') {
                saveJumpToHistory('DJ', h, { rsi: lastResult.rsi, stiffness: lastResult.stiffness, contactTime: lastResult.contactTime });
            } else if (selectedJumpType === 'CMJ' || selectedJumpType === 'ABALAKOV') {
                saveJumpToHistory(selectedJumpType, h, { rsiMod: lastResult.rsiMod, cmTime: lastResult.cmTime });
            } else {
                saveJumpToHistory(selectedJumpType, h);
            }

            // Update UI
            $('result-cm').textContent = h.toFixed(1);
            $('result-jump-type').textContent = jumpTypeInfo[selectedJumpType].name;
            $('rating').textContent = getRating(h);

            // Stats
            const stats = $('result-stats');
            if (selectedJumpType === 'DJ') {
                stats.className = 'result-stats five-cols';
                stats.innerHTML = `
                    <div class="stat-item"><div class="stat-value">${(h/2.54).toFixed(1)}"</div><div class="stat-label">Inch</div></div>
                    <div class="stat-item"><div class="stat-value">${(flightTime*1000).toFixed(0)}</div><div class="stat-label">Flight ms</div></div>
                    <div class="stat-item"><div class="stat-value">${(lastResult.contactTime*1000).toFixed(0)}</div><div class="stat-label">Contact ms</div></div>
                    <div class="stat-item highlight"><div class="stat-value">${lastResult.rsi.toFixed(2)}</div><div class="stat-label">RSI</div></div>
                    <div class="stat-item"><div class="stat-value">${lastResult.stiffness.toFixed(1)}</div><div class="stat-label">Stiff</div></div>
                `;
            } else if (selectedJumpType === 'CMJ' || selectedJumpType === 'ABALAKOV') {
                stats.className = 'result-stats five-cols';
                stats.innerHTML = `
                    <div class="stat-item"><div class="stat-value">${(h/2.54).toFixed(1)}"</div><div class="stat-label">Inch</div></div>
                    <div class="stat-item"><div class="stat-value">${(flightTime*1000).toFixed(0)}</div><div class="stat-label">Flight ms</div></div>
                    <div class="stat-item"><div class="stat-value">${(lastResult.cmTime*1000).toFixed(0)}</div><div class="stat-label">CM ms</div></div>
                    <div class="stat-item highlight"><div class="stat-value">${lastResult.rsiMod.toFixed(2)}</div><div class="stat-label">RSI-mod</div></div>
                    ${lastResult.power ? `<div class="stat-item"><div class="stat-value">${lastResult.power}</div><div class="stat-label">Watt</div></div>` : `<div class="stat-item"><div class="stat-value">${flightFrames}</div><div class="stat-label">Frames</div></div>`}
                `;
            } else {
                // SJ
                stats.className = 'result-stats' + (lastResult.power ? ' four-cols' : '');
                stats.innerHTML = `
                    <div class="stat-item"><div class="stat-value">${(h/2.54).toFixed(1)}"</div><div class="stat-label">Inches</div></div>
                    <div class="stat-item"><div class="stat-value">${flightTime.toFixed(3)}s</div><div class="stat-label">Flight</div></div>
                    <div class="stat-item"><div class="stat-value">${flightFrames}</div><div class="stat-label">Frames</div></div>
                    ${lastResult.power ? `<div class="stat-item highlight"><div class="stat-value">${lastResult.power}</div><div class="stat-label">Watt</div></div>` : ''}
                `;
            }

            // Bosco Indices
            showBoscoIndices();

            // Force-Power Profile
            updateForcePowerProfile(h);

            // Benchmarks - only for CMJ (literature validated)
            if (selectedJumpType === 'CMJ') {
                generateBenchmarkBars(h);
                $('benchmarks-section').style.display = 'block';
            } else {
                $('benchmarks-section').style.display = 'none';
            }

            $('results').classList.add('visible');
            $('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
            navigator.vibrate?.([50, 50, 100]);
        }

        function getRating(h) {
            if (h >= 80) return '‚ö° √âLITE';
            if (h >= 65) return 'üî• ECCELLENTE';
            if (h >= 50) return '‚úì BUONO';
            if (h >= 40) return '‚Üí NELLA MEDIA';
            if (h >= 30) return '‚Üó DA MIGLIORARE';
            return 'üéØ PRINCIPIANTE';
        }

        function showBoscoIndices() {
            const grid = $('bosco-grid');
            const indices = $('bosco-indices');
            let html = '';
            let hasNewIndex = false;
            
            const cmjH = getJumpHeight(jumpHistory.CMJ);
            const sjH = getJumpHeight(jumpHistory.SJ);
            const abaH = getJumpHeight(jumpHistory.ABALAKOV);

            // RSI-mod for CMJ/Abalakov (current result)
            if ((selectedJumpType === 'CMJ' || selectedJumpType === 'ABALAKOV') && lastResult.rsiMod) {
                hasNewIndex = true;
                const rsiModText = lastResult.rsiMod >= 0.6 ? '‚úÖ √âlite' : lastResult.rsiMod >= 0.45 ? 'üëç Buono' : lastResult.rsiMod >= 0.35 ? '‚û°Ô∏è Medio' : '‚ö†Ô∏è Base';
                html += `<div class="bosco-item"><div class="bosco-value">${lastResult.rsiMod.toFixed(2)}</div><div class="bosco-label">RSI-mod</div><div class="bosco-interpretation">${rsiModText}</div></div>`;
            }

            // IE: Indice di Elasticit√†
            if (cmjH && sjH) {
                hasNewIndex = true;
                const ie = ((cmjH - sjH) / sjH * 100);
                const ieText = ie >= 15 ? '‚úÖ Ottima elasticit√†' : ie >= 10 ? 'üëç Buona' : '‚ö†Ô∏è Deficit SSC';
                html += `<div class="bosco-item"><div class="bosco-value">${ie.toFixed(1)}%</div><div class="bosco-label">Indice Elasticit√†</div><div class="bosco-interpretation">${ieText}</div></div>`;
            }

            // ICB: Indice Coordinazione Braccia
            if (cmjH && abaH) {
                hasNewIndex = true;
                const icb = ((abaH - cmjH) / cmjH * 100);
                const icbText = icb >= 12 ? '‚úÖ Ottima coord.' : icb >= 8 ? 'üëç Buona' : '‚ö†Ô∏è Da migliorare';
                html += `<div class="bosco-item"><div class="bosco-value">${icb.toFixed(1)}%</div><div class="bosco-label">Indice Coord. Braccia</div><div class="bosco-interpretation">${icbText}</div></div>`;
            }

            // Power
            if (lastResult.power) {
                html += `<div class="bosco-item"><div class="bosco-value">${lastResult.power} W</div><div class="bosco-label">Potenza</div></div>`;
            }

            // RSI & Stiffness for DJ
            if (selectedJumpType === 'DJ') {
                const rsiText = lastResult.rsi >= 2.5 ? '√âlite' : lastResult.rsi >= 2.0 ? 'Buono' : lastResult.rsi >= 1.5 ? 'Medio' : 'Base';
                html += `<div class="bosco-item"><div class="bosco-value">${lastResult.rsi.toFixed(2)}</div><div class="bosco-label">RSI</div><div class="bosco-interpretation">${rsiText}</div></div>`;
                html += `<div class="bosco-item"><div class="bosco-value">${lastResult.stiffness.toFixed(1)}</div><div class="bosco-label">Stiffness</div></div>`;
            }

            if (html) {
                grid.innerHTML = html;
                indices.style.display = 'block';
                if (hasNewIndex) {
                    indices.classList.add('new-index');
                    setTimeout(() => indices.classList.remove('new-index'), 600);
                }
            } else {
                indices.style.display = 'none';
            }
        }

        // ============================================
        // FORCE-POWER PROFILE
        // ============================================
        function updateForcePowerProfile(cmjHeight) {
            const weight = parseFloat($('weight-input').value);
            const squat = parseFloat($('squat-input').value);
            const fpSection = $('fp-profile');
            
            // Always show the section
            fpSection.style.display = 'block';
            
            // If missing data, show placeholder
            if (!weight || !squat) {
                $('fp-rel-str').textContent = '--';
                $('fp-cmj').textContent = cmjHeight.toFixed(0) + 'cm';
                $('fp-power').textContent = lastResult.power ? lastResult.power + 'W' : '--';
                $('fp-icon').textContent = 'üìä';
                $('fp-quadrant-name').textContent = 'Dati Incompleti';
                $('fp-quadrant-desc').textContent = 'Inserisci peso e Squat 1RM per sbloccare l\'analisi del tuo profilo forza-potenza e ricevere raccomandazioni personalizzate.';
                $('fp-deficit').style.display = 'none';
                return;
            }
            
            // Calculate metrics
            const relStr = squat / weight;
            const power = lastResult.power || Math.round(60.7 * cmjHeight + 45.3 * weight - 2055);
            
            // Expected CMJ based on relative strength (research correlation)
            // Approx: 20 + (relStr * 15) for baseline, adjusted
            const expectedCMJ = 18 + (relStr * 18);
            const deficit = expectedCMJ - cmjHeight;
            
            // Update metrics display
            $('fp-rel-str').textContent = relStr.toFixed(2) + 'x';
            $('fp-cmj').textContent = cmjHeight.toFixed(0) + 'cm';
            $('fp-power').textContent = power + 'W';
            
            // Determine quadrant
            const isStrong = relStr >= 1.5;  // Above 1.5x BW squat = strong
            const isExplosive = cmjHeight >= 45;  // Above 45cm = good jump
            
            let quadrant, icon, desc;
            
            if (isStrong && isExplosive) {
                // COMPLETE - Strong and explosive
                quadrant = 'Atleta Completo';
                icon = '‚ö°';
                desc = 'Ottimo equilibrio forza-potenza. Mantieni questo livello e lavora sulle qualit√† sport-specifiche per massimizzare il transfer in campo.';
            } else if (isStrong && !isExplosive) {
                // DEFICIT - Strong but not explosive
                quadrant = 'Deficit di Potenza';
                icon = 'üéØ';
                desc = 'Hai la forza ma non la sfrutti! Il tuo potenziale √® bloccato. Focus su pliometria, lavoro balistico e jump training per convertire la forza in esplosivit√†.';
            } else if (!isStrong && isExplosive) {
                // POTENTIAL - Explosive but not strong
                quadrant = 'Potenziale Inespresso';
                icon = 'üìà';
                desc = 'Buona esplosivit√† naturale, ma costruire pi√π forza massimale sbloccher√† livelli superiori. Focus su squat e forza degli arti inferiori.';
            } else {
                // BEGINNER - Neither strong nor explosive
                quadrant = 'Costruisci le Basi';
                icon = 'üèóÔ∏è';
                desc = 'Priorit√†: costruire una solida base di forza. Un programma strutturato di forza e condizionamento ti porter√† rapidamente a livelli superiori.';
            }
            
            // Update UI
            $('fp-icon').textContent = icon;
            $('fp-quadrant-name').textContent = quadrant;
            $('fp-quadrant-desc').textContent = desc;
            
            // Show deficit if significant
            if (deficit > 3) {
                $('fp-deficit').style.display = 'inline-block';
                $('fp-deficit').textContent = `Gap: ${deficit.toFixed(0)}cm sotto il potenziale`;
            } else if (deficit < -5) {
                $('fp-deficit').style.display = 'inline-block';
                $('fp-deficit').textContent = `+${Math.abs(deficit).toFixed(0)}cm sopra le attese!`;
            } else {
                $('fp-deficit').style.display = 'none';
            }
            
            // Save to athlete data
            athleteData.relativeStrength = relStr;
            athleteData.quadrant = quadrant;
            localStorage.setItem('hopp_athlete', JSON.stringify(athleteData));
        }

        function generateBenchmarkBars(h) {
            const c = $('benchmark-bars');
            c.innerHTML = Object.entries(SPORT_BENCHMARKS).map(([s, d]) => {
                const fill = Math.min(100, d.elite / 90 * 100);
                const mark = Math.min(98, Math.max(2, h / 90 * 100));
                return `<div class="benchmark-bar"><div class="benchmark-fill" style="width:${fill}%"></div><div class="benchmark-marker" style="left:${mark}%"></div><div class="benchmark-labels"><span class="benchmark-sport">${d.emoji} ${s}</span><span class="benchmark-range">${d.avg}/${d.good}/${d.elite}</span></div></div>`;
            }).join('');
        }

        // ============================================
        // SHARE
        // ============================================
        $('share-btn').addEventListener('click', async () => {
            const canvas = $('share-canvas'), ctx = canvas.getContext('2d'), w = 1080, h = 1920;
            ctx.fillStyle = '#0D0D0D'; ctx.fillRect(0, 0, w, h);
            const gr = ctx.createRadialGradient(w/2, h/3, 0, w/2, h/3, w);
            gr.addColorStop(0, 'rgba(212,175,55,0.15)'); gr.addColorStop(1, 'transparent');
            ctx.fillStyle = gr; ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = '#D4AF37'; ctx.font = '80px serif'; ctx.textAlign = 'center';
            ctx.fillText('·ö∫ ·õü ·õà ·õà', w/2, 200);
            ctx.fillStyle = '#F5F5F5'; ctx.font = 'bold 72px Georgia'; ctx.fillText('H«™PP', w/2, 320);
            ctx.fillStyle = 'rgba(245,245,245,0.6)'; ctx.font = '36px Arial'; ctx.fillText(jumpTypeInfo[selectedJumpType].name, w/2, 400);
            ctx.fillStyle = '#D4AF37'; ctx.font = 'bold 280px Georgia'; ctx.fillText(lastResult.cm.toFixed(1), w/2, 750);
            ctx.fillStyle = 'rgba(245,245,245,0.8)'; ctx.font = 'bold 80px Georgia'; ctx.fillText('cm', w/2, 860);
            ctx.fillStyle = '#1A1A1A'; ctx.beginPath(); ctx.roundRect(w/2-200, 920, 400, 80, 40); ctx.fill();
            ctx.strokeStyle = '#D4AF37'; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = '#D4AF37'; ctx.font = 'bold 40px Georgia'; ctx.fillText(getRating(lastResult.cm), w/2, 975);
            ctx.fillStyle = 'rgba(245,245,245,0.5)'; ctx.font = '32px Arial';
            let extra = `${(lastResult.cm/2.54).toFixed(1)}"`;
            if (lastResult.power) extra += ` ‚Ä¢ ${lastResult.power}W`;
            if (lastResult.rsi) extra += ` ‚Ä¢ RSI ${lastResult.rsi.toFixed(2)}`;
            if (lastResult.rsiMod) extra += ` ‚Ä¢ RSI-mod ${lastResult.rsiMod.toFixed(2)}`;
            ctx.fillText(extra, w/2, 1100);
            ctx.fillStyle = '#D4AF37'; ctx.font = 'bold 36px Georgia'; ctx.fillText('NICHOLAS RUBINI', w/2, 1700);
            ctx.font = '32px serif'; ctx.fillText('·õü ·öπ ·õÅ ·öæ ·öæ', w/2, 1760);
            ctx.fillStyle = 'rgba(245,245,245,0.4)'; ctx.font = '28px Arial'; ctx.fillText('nicholasrubini.it', w/2, 1820);
            try {
                const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                const file = new File([blob], 'hopp.png', { type: 'image/png' });
                if (navigator.canShare?.({ files: [file] })) await navigator.share({ files: [file], title: 'H«™PP Result' });
                else { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'hopp.png'; a.click(); }
            } catch(e) {}
        });

        // ============================================
        // RESET
        // ============================================
        $('reset-btn').addEventListener('click', () => {
            takeoffFrame = landingFrame = contactFrame = cmStartFrame = null;
            $('results').classList.remove('visible');
            $('calculate-btn').disabled = true;
            $('upload-zone').style.display = 'block';
            $('video-section').classList.remove('active');
            $('video-player').src = '';
            $('video-input').value = '';
            $('fps-confirm-banner').classList.remove('visible');
            fpsConfirmed = false;
            $('fps-badge').textContent = 'MANUALE';
            $('fps-badge').className = 'fps-badge manual';
            updateJumpTypeUI();
        });

        $('install-close').addEventListener('click', () => {
            $('install-prompt').classList.remove('visible');
            localStorage.setItem('hopp-dismissed', '1');
        });

        // Prevent double-tap zoom
        let lt = 0;
        document.addEventListener('touchend', e => { const n = Date.now(); if (n - lt <= 300) e.preventDefault(); lt = n; }, false);

        // Init
        init();
    </script>
</body>
</html>
